<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8"/>
  <title>Admin • Productos — Genesis</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    /* (igual que tenías, lo mantuve sin cambios) */
    :root{
      --bg:#0f1720;
      --card:#ffffff;
      --muted:#98a0ad;
      --accent:#ff3b30;
      --glass: rgba(255,255,255,0.04);
      --shadow: 0 8px 30px rgba(2,6,23,0.4);
      --maxw:1100px;
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:Inter, system-ui, -apple-system, "Segoe UI", Roboto, Arial;color:#111;background:linear-gradient(180deg,#f5f7fb,#eef2f7);-webkit-font-smoothing:antialiased}
    .container{max-width:var(--maxw);margin:28px auto;padding:18px}
    header{display:flex;align-items:center;justify-content:space-between;gap:16px;margin-bottom:18px}
    .brand{display:flex;gap:12px;align-items:center}
    .logo{width:48px;height:48px;border-radius:10px;background:linear-gradient(135deg,var(--accent),#ff7a6b);display:flex;align-items:center;justify-content:center;color:#fff;font-weight:700}
    h1{margin:0;font-size:18px}
    .controls{display:flex;gap:8px;align-items:center}
    button.btn{border:0;padding:10px 14px;border-radius:10px;cursor:pointer;font-weight:600}
    .btn.ghost{background:transparent;border:1px solid rgba(0,0,0,0.06)}
    .btn.primary{background:var(--accent);color:#fff;box-shadow: 0 6px 18px rgba(255,59,48,0.12)}
    .layout{display:grid;grid-template-columns:1fr 420px;gap:18px}
    @media (max-width:900px){ .layout{grid-template-columns:1fr} }

    /* left panel */
    .card{background:var(--card);border-radius:12px;padding:14px;box-shadow:var(--shadow)}
    .toolbar{display:flex;justify-content:space-between;align-items:center;margin-bottom:10px;gap:8px}
    .search{flex:1;display:flex;gap:8px}
    .search input{width:100%;padding:10px;border-radius:10px;border:1px solid #e6e9ee}
    table{width:100%;border-collapse:collapse}
    th,td{padding:10px;border-bottom:1px solid #f1f3f6;text-align:left;vertical-align:middle}
    th{color:var(--muted);font-weight:600;font-size:13px}
    td .thumb{width:56px;height:56px;border-radius:8px;object-fit:cover;border:1px solid #eee}
    .row-actions{display:flex;gap:8px;justify-content:flex-end}
    .empty{padding:28px;text-align:center;color:var(--muted)}

    /* editor card */
    form .field{margin-bottom:10px}
    label{display:block;font-size:13px;margin-bottom:6px;color:#444}
    input[type="text"],input[type="number"],textarea,select{
      width:100%;padding:10px;border-radius:8px;border:1px solid #e6e9ee;background:#fff;font-size:14px
    }
    textarea{min-height:100px;resize:vertical}
    .img-preview{width:100%;height:160px;border-radius:10px;object-fit:contain;border:1px dashed #eee;background:#fafafa;display:block}
    .form-actions{display:flex;gap:8px;justify-content:flex-end;margin-top:8px}
    .small{font-size:12px;color:var(--muted)}

    /* responsive tweaks */
    @media (max-width:600px){
      .img-preview{height:140px}
      .controls{flex-direction:column;align-items:stretch}
    }
    /* subtle loader */
    .loader{display:inline-block;width:18px;height:18px;border-radius:50%;border:3px solid rgba(0,0,0,0.06);border-top-color:var(--accent);animation:spin 1s linear infinite}
    @keyframes spin{to{transform:rotate(360deg)}}
  </style>
</head>
<body>
  <div class="container">
    <header>
      <div class="brand">
        <div class="logo">G</div>
        <div>
          <h1>Genesis — Panel Admin</h1>
          <div class="small">Administra productos y contenidos</div>
        </div>
      </div>
      <div class="controls">
        <button id="refreshBtn" class="btn ghost">Refrescar</button>
        <button id="newBtn" class="btn primary">Nuevo producto</button>
      </div>
    </header>

    <div class="layout">
      <div class="card">
        <div class="toolbar">
          <div class="search">
            <input id="searchInput" placeholder="Buscar por nombre..." />
          </div>
          <div class="small" id="countInfo">Cargando...</div>
        </div>

        <div id="listWrap" style="max-height:640px;overflow:auto">
          <table id="productsTable" aria-live="polite">
            <thead><tr><th>Producto</th><th>Precio</th><th>Oferta</th><th style="width:120px"></th></tr></thead>
            <tbody></tbody>
          </table>
          <div id="emptyList" class="empty" style="display:none">No hay productos aún.</div>
        </div>
      </div>

      <aside class="card" id="editorCard">
        <h3 id="editorTitle">Editar producto</h3>
        <form id="productForm" autocomplete="off">
          <input type="hidden" name="id" />
          <div class="field">
            <label>Nombre</label>
            <input name="nombre" type="text" required />
          </div>
          <div class="field">
            <label>Descripción</label>
            <textarea name="descripcion"></textarea>
          </div>
          <div class="field" style="display:flex;gap:8px">
            <div style="flex:1">
              <label>Precio</label>
              <input name="precio" type="number" step="0.01" required />
            </div>
            <div style="width:110px">
              <label>Stock</label>
              <input name="stock" type="number" />
            </div>
          </div>
          <div class="field" style="display:flex;gap:8px">
            <div style="flex:1">
              <label>En oferta?</label>
              <select name="oferta"><option value="false">No</option><option value="true">Sí</option></select>
            </div>
            <div style="width:140px">
              <label>Descuento %</label>
              <input name="descuento" type="number" min="0" max="100" />
            </div>
          </div>

          <div class="field">
            <label>Imagen (subir)</label>
            <input id="imageInput" type="file" name="image" accept="image/*" />
            <div style="margin-top:8px">
              <img id="imgPreview" class="img-preview" src="" alt="Preview" />
            </div>
            <div class="small" style="margin-top:6px">La imagen máxima es 5 MB. Se guardará en /Images/</div>
          </div>

          <div class="form-actions">
            <button id="deleteBtn" class="btn ghost" type="button">Eliminar</button>
            <button id="clearBtn" class="btn ghost" type="button">Limpiar</button>
            <button id="saveBtn" class="btn primary" type="submit">
              <span id="saveLabel">Guardar</span>
              <span id="saveLoader" style="display:none;margin-left:8px" class="loader"></span>
            </button>
          </div>

          <p class="small" style="margin-top:10px">Los cambios se guardan en <code>/public/Json/products.json</code></p>
        </form>
      </aside>
    </div>
  </div>

<script>
/* Admin UI JS
   - Preview local file with FileReader
   - Upload image to /api/upload-image (multipart)
   - Create/Update/Delete products through /api/products endpoints
*/

const API_BASE = '/api'; // relative - works when backend serves frontend
const IMAGE_UPLOAD_ENDPOINT = '/api/upload-image'; // <- endpoint correcto
const productsTableBody = document.querySelector('#productsTable tbody');
const countInfo = document.getElementById('countInfo');
const emptyList = document.getElementById('emptyList');

let productsCache = [];

// Helper: fetch JSON and throw helpful message
async function fetchJson(url, opts = {}) {
  const res = await fetch(url, opts);
  if (!res.ok) {
    const text = await res.text().catch(()=>'');
    // intenta parsear JSON de error si lo hay
    try {
      const j = JSON.parse(text);
      throw new Error(`${res.status} ${res.statusText} - ${j.error || j.message || text}`);
    } catch (e) {
      throw new Error(`${res.status} ${res.statusText} ${text}`);
    }
  }
  return res.json();
}

// Preview local image immediately
const imageInput = document.getElementById('imageInput');
const imgPreview = document.getElementById('imgPreview');
imageInput.addEventListener('change', () => {
  const f = imageInput.files && imageInput.files[0];
  if (!f) {
    imgPreview.src = '';
    return;
  }
  const reader = new FileReader();
  reader.onload = (e) => { imgPreview.src = e.target.result; };
  reader.readAsDataURL(f);
});

// Load products and render table
async function loadProducts(query='') {
  try {
    const data = await fetchJson(API_BASE + '/products');
    productsCache = Array.isArray(data) ? data : [];
    const filtered = query ? productsCache.filter(p => (p.nombre||'').toLowerCase().includes(query.toLowerCase())) : productsCache;
    renderProducts(filtered);
  } catch (err) {
    console.error(err);
    alert('Error cargando productos: ' + err.message);
    productsCache = [];
    renderProducts([]);
  }
}

function renderProducts(list) {
  productsTableBody.innerHTML = '';
  if (!list.length) {
    emptyList.style.display = 'block';
    countInfo.textContent = '0 productos';
    return;
  }
  emptyList.style.display = 'none';
  countInfo.textContent = `${list.length} productos`;
  list.forEach(p => {
    const tr = document.createElement('tr');
    const imgUrl = p.imagen || '';
    tr.innerHTML = `
      <td style="display:flex;gap:12px;align-items:center">
        <img class="thumb" src="${imgUrl || '/Images/placeholder.png'}" alt="thumb" onerror="this.src='/Images/placeholder.png'"/>
        <div>
          <div style="font-weight:600">${escapeHtml(p.nombre||'—')}</div>
          <div class="small">${escapeHtml((p.descripcion||'').slice(0,80))}</div>
        </div>
      </td>
      <td>$${Number(p.precio||0).toFixed(2)}</td>
      <td>${p.oferta ? 'Sí (' + (p.descuento||0) + '%)' : 'No'}</td>
      <td class="row-actions">
        <button class="btn ghost editBtn" data-id="${p.id}">Editar</button>
      </td>
    `;
    productsTableBody.appendChild(tr);
  });
  // attach edit handlers
  document.querySelectorAll('.editBtn').forEach(b => {
    b.onclick = () => loadToForm(b.dataset.id);
  });
}

// Fill form with product data
async function loadToForm(id) {
  try {
    const p = await fetchJson(API_BASE + '/products/' + id);
    const form = document.getElementById('productForm');
    form.id.value = p.id || '';
    form.nombre.value = p.nombre || '';
    form.descripcion.value = p.descripcion || '';
    form.precio.value = p.precio || 0;
    form.stock.value = p.stock || 0;
    form.oferta.value = p.oferta ? 'true' : 'false';
    form.descuento.value = p.descuento || 0;
    imgPreview.src = p.imagen || '';
    document.getElementById('editorTitle').innerText = 'Editar producto';
    window.scrollTo({ top: 0, behavior: 'smooth' });
  } catch (err) {
    alert('Error cargando producto: ' + err.message);
  }
}

// UI helpers to disable/enable save
function setSaving(isSaving) {
  const btn = document.getElementById('saveBtn');
  const label = document.getElementById('saveLabel');
  const loader = document.getElementById('saveLoader');
  if (isSaving) {
    btn.disabled = true;
    label.textContent = 'Guardando...';
    loader.style.display = 'inline-block';
  } else {
    btn.disabled = false;
    label.textContent = 'Guardar';
    loader.style.display = 'none';
  }
}

// Create or update product (handles image upload first)
document.getElementById('productForm').onsubmit = async function(e) {
  e.preventDefault();
  const form = e.target;
  const id = form.id.value;
  const body = {
    nombre: form.nombre.value,
    descripcion: form.descripcion.value,
    precio: Number(form.precio.value || 0),
    stock: Number(form.stock.value || 0),
    oferta: form.oferta.value === 'true',
    descuento: Number(form.descuento.value || 0),
  };

  setSaving(true);
  try {
    // Upload image if selected
    const file = imageInput.files && imageInput.files[0];
    if (file) {
      const fd = new FormData();
      fd.append('image', file);
      const upResp = await fetch(IMAGE_UPLOAD_ENDPOINT, {
        method: 'POST',
        body: fd
      });
      const upText = await upResp.text().catch(()=>'');
      let upJson = {};
      try { upJson = upText ? JSON.parse(upText) : {}; } catch(e) { upJson = { raw: upText }; }

      if (!upResp.ok) {
        // intenta mostrar detalle JSON si vino
        throw new Error('Error subiendo imagen: ' + upResp.status + ' ' + (upJson.error || upJson.details || upJson.raw || upText));
      }
      if (!upJson.url) throw new Error('Respuesta inválida del servidor al subir imagen: ' + JSON.stringify(upJson));
      body.imagen = upJson.url;
      imgPreview.src = upJson.url;
    } else {
      // si no hay archivo: si la vista previa ya tiene una URL pública, úsala
      // ignoramos data: URLs (son previews locales sin path público)
      if (imgPreview.src && !imgPreview.src.startsWith('data:') && imgPreview.src.trim() !== '') {
        // si contiene el hostname completo, convertir a path relativo (/Images/...)
        try {
          const u = new URL(imgPreview.src, window.location.href);
          body.imagen = u.pathname;
        } catch (e) {
          // fallback: usar tal cual
          body.imagen = imgPreview.src;
        }
      } else {
        body.imagen = ''; // sin imagen
      }
    }

    if (!id) {
      // create
      await fetchJson(API_BASE + '/products', {
        method: 'POST',
        headers: {'Content-Type':'application/json'},
        body: JSON.stringify(body)
      });
      alert('Producto creado correctamente');
    } else {
      await fetchJson(API_BASE + '/products/' + id, {
        method: 'PUT',
        headers: {'Content-Type':'application/json'},
        body: JSON.stringify(body)
      });
      alert('Producto actualizado correctamente');
    }

    // refresh
    await loadProducts();
    form.reset();
    imgPreview.src = '';
    document.getElementById('editorTitle').innerText = 'Editar producto';
  } catch (err) {
    console.error(err);
    // err puede venir con mucho texto, limpiamos un poco
    let msg = err && err.message ? err.message : String(err);
    alert('Error guardando producto: ' + msg);
  } finally {
    setSaving(false);
  }
};

// Delete product
document.getElementById('deleteBtn').onclick = async function() {
  const id = document.getElementById('productForm').id.value;
  if (!id) return alert('No hay producto seleccionado');
  if (!confirm('¿Eliminar producto?')) return;
  try {
    await fetchJson(API_BASE + '/products/' + id, { method: 'DELETE' });
    alert('Producto eliminado');
    document.getElementById('productForm').reset();
    imgPreview.src = '';
    await loadProducts();
  } catch (err) {
    console.error(err);
    alert('Error eliminando producto: ' + err.message);
  }
};

// New, refresh, clear
document.getElementById('newBtn').onclick = () => {
  const f = document.getElementById('productForm');
  f.reset(); f.id.value = ''; imgPreview.src = '';
  document.getElementById('editorTitle').innerText = 'Crear producto nuevo';
};
document.getElementById('refreshBtn').onclick = () => loadProducts(document.getElementById('searchInput').value);

// Clear
document.getElementById('clearBtn').onclick = () => {
  document.getElementById('productForm').reset(); document.getElementById('productForm').id.value=''; imgPreview.src='';
};

// Search filter
document.getElementById('searchInput').addEventListener('input', (e) => {
  const q = e.target.value.trim();
  if (!q) renderProducts(productsCache);
  else renderProducts(productsCache.filter(p => (p.nombre||'').toLowerCase().includes(q.toLowerCase())));
});

// helper escape
function escapeHtml(s) {
  if (!s) return '';
  return s.replace(/[&<>"']/g, (m)=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' })[m]);
}

// kick off
loadProducts().catch(e => {
  console.error(e);
  alert('Error inicial al cargar productos: ' + e.message);
});
</script>
</body>
</html>
